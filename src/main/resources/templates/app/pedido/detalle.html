{% set csrfParamName = _csrf.parameterName %}
{% set csrfToken = _csrf.token %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle del Pedido - Centro Cocotero</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/styles-navbar.css">
</head>

<body class="d-flex flex-column min-vh-100">

{% include 'fragments/header' %}

<div class="container py-4 mt-5 pt-3">
    <div class="row">
        <div class="col-12 mb-4">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Inicio</a></li>
                    <li class="breadcrumb-item"><a href="/app/perfil">Mi Perfil</a></li>
                    <li class="breadcrumb-item active">Pedido #{{ pedido.id }}</li>
                </ol>
            </nav>
            <h2><i class="bi bi-receipt"></i> Detalle del Pedido #{{ pedido.id }}</h2>
        </div>
    </div>

    <div class="row g-4">
        <!-- Información del Pedido -->
        <div class="col-lg-8">
            <div class="card shadow mb-4" style="border: 2px solid #422A21; border-radius: 12px; overflow: hidden;">
                <div class="card-header text-white" style="background-color: #16BABD; border-bottom: 2px solid #422A21;">
                    <h5 class="mb-0"><i class="bi bi-box-seam"></i> Productos del Pedido</h5>
                </div>
                <div class="card-body bg-suave">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Precio Unit.</th>
                                    <th>Cantidad</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for linea in pedido.lineas %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if linea.producto.imagenes is not empty %}
                                                <img src="{{ linea.producto.imagenes[0] }}" 
                                                     alt="{{ linea.producto.nombre }}"
                                                     width="50" height="50"
                                                     class="rounded me-3"
                                                     style="object-fit: cover; border: 2px solid #422A21;">
                                            {% else %}
                                                <img src="/images/placeholder.jpg" 
                                                     alt="Sin imagen"
                                                     width="50" height="50"
                                                     class="rounded me-3"
                                                     style="object-fit: cover; border: 2px solid #422A21;">
                                            {% endif %}
                                            <div>
                                                <strong>{{ linea.producto.nombre }}</strong>
                                                <br>
                                                <small class="text-muted">{{ linea.producto.categoria.descripcion }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ linea.precioUnitario | formatPrice }}</td>
                                    <td>{{ linea.cantidad }}</td>
                                    <td><strong>{{ linea.subtotal | formatPrice }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-active">
                                    <td colspan="3" class="text-end"><strong>TOTAL:</strong></td>
                                    <td><strong class="fs-5" style="color: #488B49;">{{ pedido.total | formatPrice }}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Dirección de Envío -->
            {% if pedido.direccionEnvio %}
            <div class="card shadow" style="border: 2px solid #422A21; border-radius: 12px; overflow: hidden;">
                <div class="card-header text-white" style="background-color: #FF9F1C; border-bottom: 2px solid #422A21;">
                    <h5 class="mb-0 text-dark"><i class="bi bi-geo-alt-fill"></i> Dirección de Envío</h5>
                </div>
                <div class="card-body bg-suave">
                    <p class="mb-0">{{ pedido.direccionEnvio }}</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Información Lateral -->
        <div class="col-lg-4">
            <!-- Estado del Pedido -->
            <div class="card shadow mb-4" style="border: 2px solid #422A21; border-radius: 12px; overflow: hidden;">
                <div class="card-header text-white" style="background-color: #488B49; border-bottom: 2px solid #422A21;">
                    <h5 class="mb-0"><i class="bi bi-info-circle-fill"></i> Estado del Pedido</h5>
                </div>
                <div class="card-body bg-suave text-center">
                    <span class="badge fs-5 px-4 py-2
                        {% if pedido.estado == 'PENDIENTE' %}bg-warning text-dark
                        {% elseif pedido.estado == 'PROCESANDO' %}bg-info
                        {% elseif pedido.estado == 'ENVIADO' %}bg-primary
                        {% elseif pedido.estado == 'ENTREGADO' %}bg-success
                        {% elseif pedido.estado == 'CANCELADO' %}bg-danger
                        {% else %}bg-secondary
                        {% endif %}">
                        {{ pedido.estado }}
                    </span>

                    <hr>

                    <div class="text-start">
                        <p class="mb-2">
                            <i class="bi bi-calendar-event text-primary"></i>
                            <strong>Fecha del pedido:</strong><br>
                            <small>{{ pedido.createdAt | formatDateTime }}</small>
                        </p>

                        {% if pedido.updatedAt is not null %}
                        <p class="mb-0">
                            <i class="bi bi-clock-history text-secondary"></i>
                            <strong>Última actualización:</strong><br>
                            <small>{{ pedido.updatedAt | formatDateTime }}</small>
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Resumen del Pedido -->
            <div class="card shadow" style="border: 2px solid #422A21; border-radius: 12px; overflow: hidden;">
                <div class="card-header text-white" style="background-color: #16BABD; border-bottom: 2px solid #422A21;">
                    <h5 class="mb-0"><i class="bi bi-calculator"></i> Resumen</h5>
                </div>
                <div class="card-body bg-suave">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Productos:</span>
                        <strong>{{ pedido.lineas | length }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Unidades totales:</span>
                        <strong>{% set totalUnidades = 0 %}{% for linea in pedido.lineas %}{% set totalUnidades = totalUnidades + linea.cantidad %}{% endfor %}{{ totalUnidades }}</strong>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <strong class="fs-5">Total:</strong>
                        <strong class="fs-5" style="color: #488B49;">{{ pedido.total | formatPrice }}</strong>
                    </div>
                </div>
            </div>

            <!-- Notas -->
            {% if pedido.notas %}
            <div class="card shadow mt-4" style="border: 2px solid #422A21; border-radius: 12px; overflow: hidden;">
                <div class="card-header text-white" style="background-color: #FF9F1C; border-bottom: 2px solid #422A21;">
                    <h5 class="mb-0 text-dark"><i class="bi bi-sticky"></i> Notas</h5>
                </div>
                <div class="card-body bg-suave">
                    <p class="mb-0">{{ pedido.notas }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Botón Descargar Factura -->
            <div class="d-grid gap-2 mt-4">
                <a href="/app/pedidos/{{ pedido.id }}/factura" class="btn btn-success" style="border: 2px solid #422A21; border-radius: 12px;">
                    <i class="bi bi-file-earmark-pdf-fill me-2"></i>Descargar Factura PDF
                </a>
            </div>

            <!-- Botón Volver -->
            <div class="d-grid gap-2 mt-3">
                <a href="/app/perfil" class="btn btn-secondary" style="border: 2px solid #422A21; border-radius: 12px;">
                    <i class="bi bi-arrow-left me-2"></i>Volver al Perfil
                </a>
            </div>
        </div>
    </div>
</div>

{% include 'fragments/footer' %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
